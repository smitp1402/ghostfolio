@if (canShow) {
  <div class="gauntlet-widget" [class.gauntlet-widget-header]="renderInHeader">
    @if (isOpen) {
      <div class="gauntlet-panel" (click)="$event.stopPropagation()">
        <div class="gauntlet-header">
          <div class="gauntlet-header-title">
            <span class="gauntlet-header-title-icon-wrap" aria-hidden="true">
              <ion-icon class="gauntlet-header-title-icon" name="sparkles-outline" />
            </span>
            <span i18n>AI Finance Agent</span>
          </div>
          <div class="gauntlet-header-actions">
            <button
              class="gauntlet-suggestions-toggle"
              [class.gauntlet-suggestions-toggle-attention]="!showSuggestedPrompts && !isLoading"
              mat-stroked-button
              type="button"
              (click)="toggleSuggestedPrompts($event)"
              [disabled]="isLoading"
            >
              {{ showSuggestedPrompts ? 'Hide queries' : 'Suggested queries' }}
            </button>
            <button
              class="gauntlet-suggestions-toggle"
              mat-stroked-button
              type="button"
              (click)="startNewChat($event)"
              [disabled]="isLoading"
              i18n
            >
              New chat
            </button>
            <button
              class="gauntlet-close"
              mat-icon-button
              type="button"
              (click)="close()"
              [attr.aria-label]="'Close'"
            >
              <ion-icon name="close-outline" />
            </button>
          </div>
        </div>
        <div class="gauntlet-messages">
          @if (messages.length === 0) {
            <p class="gauntlet-placeholder" i18n>
              This finance assistant helps you understand your investments with clear, context-aware guidance on portfolio health, performance trends, recent activity, and potential risk or rule concerns.
            </p>
          }
          @if (showSuggestedPrompts) {
            <div class="gauntlet-suggestions">
              @for (suggestion of suggestedPrompts; track suggestion.query) {
                <button
                  class="gauntlet-suggestion"
                  type="button"
                  (click)="useSuggestedPrompt(suggestion.query)"
                  [disabled]="isLoading"
                >
                  {{ suggestion.query }}
                </button>
              }
            </div>
          }
          @for (msg of messages; track msg.id) {
            <div
              class="gauntlet-message"
              [class.gauntlet-message-user]="msg.role === 'user'"
              [class.gauntlet-message-assistant]="msg.role === 'assistant'"
            >
              @if (msg.role === 'assistant') {
                <div class="gauntlet-avatar" aria-hidden="true"></div>
              }
              <div class="gauntlet-bubble">
                @if (msg.role === 'assistant') {
                  <div class="gauntlet-text gauntlet-markdown">
                    @if (msg.text === '' && isLoading && $last) {
                      <span class="gauntlet-typing-dots" aria-hidden="true">
                        <span></span><span></span><span></span>
                      </span>
                    } @else {
                      <markdown [data]="msg.text" />
                    }
                  </div>
                } @else {
                  <span class="gauntlet-text">{{ msg.text }}</span>
                }
              </div>
            </div>
          }
        </div>
        <div class="gauntlet-input-row">
          <input
            class="gauntlet-input"
            type="text"
            [placeholder]="'Type a message...'"
            [(ngModel)]="inputMessage"
            (keydown.enter)="$event.preventDefault(); send()"
            [disabled]="isLoading"
            i18n-placeholder
          />
          <button
            class="gauntlet-send"
            mat-flat-button
            type="button"
            (click)="send()"
            [disabled]="isLoading || !inputMessage?.trim()"
            [attr.aria-label]="'Send'"
          >
            <ion-icon name="send-outline" />
          </button>
        </div>
      </div>
    }
    @if (renderInHeader) {
      <button
        class="gauntlet-header-trigger h-100 no-min-width px-2"
        mat-button
        type="button"
        (click)="toggle($event)"
        [attr.aria-label]="isOpen ? 'Close chat' : 'Open chat'"
      >
        <ion-icon [name]="isOpen ? 'close-outline' : 'chatbubbles-outline'" />
      </button>
    } @else {
      <button
        class="gauntlet-fab"
        mat-fab
        type="button"
        (click)="toggle($event)"
        [attr.aria-label]="isOpen ? 'Close chat' : 'Open chat'"
      >
        <ion-icon [name]="isOpen ? 'close-outline' : 'chatbubbles-outline'" />
      </button>
    }
  </div>
}
