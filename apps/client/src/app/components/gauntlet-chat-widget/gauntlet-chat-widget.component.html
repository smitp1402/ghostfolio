@if (canShow) {
  <div class="gauntlet-widget">
    @if (isOpen) {
      <div class="gauntlet-panel" (click)="$event.stopPropagation()">
        <div class="gauntlet-header">
          <div class="gauntlet-header-title">
            <ion-icon name="chatbubbles-outline" />
            <span i18n>Portfolio assistant</span>
          </div>
          <button
            class="gauntlet-close"
            mat-icon-button
            type="button"
            (click)="close()"
            [attr.aria-label]="'Close'"
          >
            <ion-icon name="close-outline" />
          </button>
        </div>
        <div class="gauntlet-messages">
          @if (messages.length === 0) {
            <p class="gauntlet-placeholder" i18n>
              Ask about your portfolio, e.g. "What's my allocation?" or "How is my portfolio?"
            </p>
          }
          @for (msg of messages; track msg.id) {
            <div
              class="gauntlet-message"
              [class.gauntlet-message-user]="msg.role === 'user'"
              [class.gauntlet-message-assistant]="msg.role === 'assistant'"
            >
              @if (msg.role === 'assistant') {
                <div class="gauntlet-avatar" aria-hidden="true"></div>
              }
              <div class="gauntlet-bubble">
                @if (msg.role === 'assistant') {
                  <div class="gauntlet-text gauntlet-markdown">
                    <markdown [data]="msg.text" />
                  </div>
                } @else {
                  <span class="gauntlet-text">{{ msg.text }}</span>
                }
              </div>
            </div>
          }
          @if (isLoading) {
            <div class="gauntlet-message gauntlet-message-assistant">
              <div class="gauntlet-avatar" aria-hidden="true"></div>
              <div class="gauntlet-bubble gauntlet-loading">
                <mat-spinner diameter="24" />
              </div>
            </div>
          }
        </div>
        <div class="gauntlet-input-row">
          <input
            class="gauntlet-input"
            type="text"
            [placeholder]="'Type a message...'"
            [(ngModel)]="inputMessage"
            (keydown.enter)="$event.preventDefault(); send()"
            [disabled]="isLoading"
            i18n-placeholder
          />
          <button
            class="gauntlet-send"
            mat-flat-button
            type="button"
            (click)="send()"
            [disabled]="isLoading || !inputMessage?.trim()"
            [attr.aria-label]="'Send'"
          >
            <ion-icon name="send-outline" />
          </button>
        </div>
      </div>
    }
    <button
      class="gauntlet-fab"
      mat-fab
      type="button"
      (click)="toggle($event)"
      [attr.aria-label]="isOpen ? 'Close chat' : 'Open chat'"
    >
      <ion-icon [name]="isOpen ? 'close-outline' : 'chatbubbles-outline'" />
    </button>
  </div>
}
